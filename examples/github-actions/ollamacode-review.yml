name: OllamaCoder Code Review

on:
  pull_request:
    types: [opened, synchronize]
  push:
    branches: [main, develop]

jobs:
  ollama-review:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Ollama
        run: |
          curl -fsSL https://ollama.ai/install.sh | sh
          # Start Ollama server in background
          ollama serve &
          sleep 5
      
      - name: Pull model
        run: ollama pull qwen3:1.7b  # Use smaller model for CI
      
      - name: Install OllamaCoder
        run: pip install ollama-coder
      
      - name: Get changed files
        id: changed
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "files=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | tr '\n' ' ')" >> $GITHUB_OUTPUT
          else
            echo "files=$(git diff --name-only HEAD~1 | tr '\n' ' ')" >> $GITHUB_OUTPUT
          fi
      
      - name: Run code review
        env:
          CHANGED_FILES: ${{ steps.changed.outputs.files }}
        run: |
          ollama-coder --headless \
            --model qwen3:1.7b \
            --no-write \
            --max-tools 20 \
            --timeout 300 \
            --output json \
            -p "Review these changed files for issues: $CHANGED_FILES

          Check for:
          1. Bugs and logic errors
          2. Security vulnerabilities
          3. Code style issues
          4. Missing tests

          Format your response with clear sections for each issue found.
          " > review_result.json
      
      - name: Post review comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const result = JSON.parse(fs.readFileSync('review_result.json', 'utf8'));
            
            if (result.response) {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## ðŸ¤– OllamaCoder Review\n\n${result.response}`
              });
            }
      
      - name: Upload review result
        uses: actions/upload-artifact@v4
        with:
          name: ollamacode-review
          path: review_result.json
